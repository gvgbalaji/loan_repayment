<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Repayment Calculator with Part Payment</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
        }
        .calculator-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-top: 20px;
        }
        .part-payment-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            display: none;
        }
        .part-payment-row {
            background-color: #fff3cd;
        }
        .summary-card {
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .summary-value {
            font-weight: bold;
            color: #0d6efd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="calculator-container">
                    <h2 class="text-center mb-4">Loan Repayment Calculator</h2>
                    
                    <form id="loanForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="principal" class="form-label">Loan Amount (₹)</label>
                                <input type="number" class="form-control" id="principal" required min="1000" step="1000" value="1000000">
                            </div>
                            <div class="col-md-6">
                                <label for="interestRate" class="form-label">Annual Interest Rate (%)</label>
                                <input type="number" class="form-control" id="interestRate" required min="0.1" step="0.01" value="8.5">
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="loanTerm" class="form-label">Loan Term (Years)</label>
                                <input type="number" class="form-control" id="loanTerm" required min="1" max="40" value="20">
                            </div>
                            <div class="col-md-6">
                                <label for="startDate" class="form-label">Start Date</label>
                                <input type="text" class="form-control" id="startDate" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Day Count Convention</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dayCountConvention" id="actual365" value="actual_365" checked>
                                <label class="form-check-label" for="actual365">
                                    Actual/365 (Actual days / 365 or 366 for leap years)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dayCountConvention" id="thirty360" value="30_360">
                                <label class="form-check-label" for="thirty360">
                                    30/360 (30 days per month, 360 days per year)
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="hasPartPayment">
                            <label class="form-check-label" for="hasPartPayment">
                                Make a Part Payment
                            </label>
                        </div>
                        
                        <div id="partPaymentSection" class="part-payment-section">
                            <h5>Part Payment Details</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="partPaymentAmount" class="form-label">Part Payment Amount (₹)</label>
                                    <input type="number" class="form-control" id="partPaymentAmount" min="1000" step="1000">
                                </div>
                                <div class="col-md-6">
                                    <label for="partPaymentDate" class="form-label">Part Payment Date</label>
                                    <input type="text" class="form-control" id="partPaymentDate">
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">Calculate Schedule</button>
                        </div>
                    </form>
                    
                    <div id="summary" class="mt-4" style="display: none;">
                        <h4 class="text-center mb-4">Loan Summary</h4>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="summary-card text-center">
                                    <h6>Total Interest</h6>
                                    <div class="summary-value" id="totalInterest">₹0.00</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="summary-card text-center">
                                    <h6>Total Payment</h6>
                                    <div class="summary-value" id="totalPayment">₹0.00</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="summary-card text-center">
                                    <h6>Loan Term</h6>
                                    <div class="summary-value" id="loanTermSummary">0 months</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive mt-4">
                            <h5 class="mb-3">Repayment Schedule</h5>
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>#</th>
                                        <th>Date</th>
                                        <th>Payment</th>
                                        <th>Principal</th>
                                        <th>Interest</th>
                                        <th>Remaining</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduleBody">
                                    <!-- Schedule will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Initialize date pickers
        flatpickr("#startDate", {
            dateFormat: "Y-m-d",
            defaultDate: "today",
        });
        
        flatpickr("#partPaymentDate", {
            dateFormat: "Y-m-d",
            minDate: "today"
        });
        
        // Toggle part payment section
        document.getElementById('hasPartPayment').addEventListener('change', function() {
            const partPaymentSection = document.getElementById('partPaymentSection');
            partPaymentSection.style.display = this.checked ? 'block' : 'none';
            if (!this.checked) {
                document.getElementById('partPaymentAmount').value = '';
                document.getElementById('partPaymentDate')._flatpickr.clear();
            }
        });
        
        // Handle form submission
        document.getElementById('loanForm').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateSchedule();
        });
        
        function calculateSchedule() {
            const formData = {
                principal: document.getElementById('principal').value,
                interestRate: document.getElementById('interestRate').value,
                loanTerm: document.getElementById('loanTerm').value,
                startDate: document.getElementById('startDate').value,
                dayCountConvention: document.querySelector('input[name="dayCountConvention"]:checked').value,
                hasPartPayment: document.getElementById('hasPartPayment').checked,
                partPaymentAmount: document.getElementById('partPaymentAmount').value,
                partPaymentDate: document.getElementById('partPaymentDate').value
            };
            
            // Validate part payment
            if (formData.hasPartPayment && (!formData.partPaymentAmount || !formData.partPaymentDate)) {
                alert('Please fill in all part payment details');
                return;
            }
            
            // Show loading state
            const submitBtn = document.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Calculating...';
            
            // Send request to server
            fetch('/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                updateSummary(data.summary);
                updateSchedule(data.schedule);
                document.getElementById('summary').style.display = 'block';
                // Scroll to results
                document.getElementById('summary').scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while calculating the schedule. Please try again.');
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            });
        }
        
        function updateSummary(summary) {
            document.getElementById('totalInterest').textContent = '₹' + summary.total_interest.toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            document.getElementById('totalPayment').textContent = '₹' + summary.total_payments.toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            
            document.getElementById('loanTermSummary').textContent = summary.loan_term_months + ' months';
        }
        
        function updateSchedule(schedule) {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';
            
            schedule.forEach(payment => {
                const row = document.createElement('tr');
                if (payment.is_part_payment) {
                    row.classList.add('part-payment-row');
                }
                
                row.innerHTML = `
                    <td>${payment.is_part_payment ? payment.payment_number : payment.payment_number}</td>
                    <td>${formatDate(payment.date)}</td>
                    <td>₹${formatCurrency(payment.payment)}</td>
                    <td>₹${formatCurrency(payment.principal)}</td>
                    <td>${payment.is_part_payment ? '-' : '₹' + formatCurrency(payment.interest)}</td>
                    <td>₹${formatCurrency(payment.remaining_balance)}</td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function formatCurrency(amount) {
            return amount.toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('en-US', options);
        }
    </script>
</body>
</html>
